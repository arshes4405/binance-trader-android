package com.example.ver20.view

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.ver20.dao.*
import kotlinx.coroutines.launch
import java.text.DecimalFormat

@Composable
fun AccountBalanceScreen(
    modifier: Modifier = Modifier,
    onShowSecuritySettings: () -> Unit = {}
) {
    val context = LocalContext.current
    val apiKeyService = remember { ApiKeyService(context) }
    val accountService = remember { AccountService() }
    val coroutineScope = rememberCoroutineScope()

    // ÏÉÅÌÉú Î≥ÄÏàòÎì§
    var hasApiKeys by remember { mutableStateOf(false) }
    var isTestnet by remember { mutableStateOf(true) }
    var apiKeyData by remember { mutableStateOf<ApiKeyData?>(null) }

    // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ ÏÉÅÌÉú
    var accountInfo by remember { mutableStateOf<AccountInfo?>(null) }
    var balances by remember { mutableStateOf<List<BalanceInfo>>(emptyList()) }
    var isLoading by remember { mutableStateOf(false) }
    var errorMessage by remember { mutableStateOf<String?>(null) }
    var totalBalanceUSD by remember { mutableStateOf(0.0) }

    // ÌÉ≠Î≥Ñ ÏûêÏÇ∞ Î∂ÑÎ•ò
    var spotBalances by remember { mutableStateOf<List<BalanceInfo>>(emptyList()) }
    var earnBalances by remember { mutableStateOf<List<BalanceInfo>>(emptyList()) }
    var futuresBalances by remember { mutableStateOf<List<BalanceInfo>>(emptyList()) }
    var spotTotalUSD by remember { mutableStateOf(0.0) }
    var earnTotalUSD by remember { mutableStateOf(0.0) }
    var futuresTotalUSD by remember { mutableStateOf(0.0) }

    // API ÌÇ§ ÏÉÅÌÉú ÌôïÏù∏ Î∞è Í≥ÑÏ¢å Ï†ïÎ≥¥ Î°úÎìú
    LaunchedEffect(Unit) {
        val keys = apiKeyService.getApiKeys()
        hasApiKeys = keys != null
        apiKeyData = keys

        if (keys != null) {
            isTestnet = keys.isTestnet
            loadAccountData(accountService, keys) { account, balanceList, total, error ->
                accountInfo = account
                balances = balanceList
                totalBalanceUSD = total
                errorMessage = error
                isLoading = false

                // ÌÉ≠Î≥Ñ ÏûêÏÇ∞ Î∂ÑÎ•ò
                classifyBalancesByTab(balanceList) { spot, earn, futures, spotTotal, earnTotal, futuresTotal ->
                    spotBalances = spot
                    earnBalances = earn
                    futuresBalances = futures
                    spotTotalUSD = spotTotal
                    earnTotalUSD = earnTotal
                    futuresTotalUSD = futuresTotal
                }
            }
        }
    }

    Card(
        modifier = modifier
            .fillMaxSize()
            .padding(16.dp),
        colors = CardDefaults.cardColors(
            containerColor = Color(0xFFE3F2FD)
        )
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            // ÏÉÅÎã® Ìó§Îçî
            AccountBalanceHeader(
                hasApiKeys = hasApiKeys,
                isTestnet = isTestnet,
                totalBalanceUSD = totalBalanceUSD,
                onRefreshClick = {
                    if (apiKeyData != null) {
                        isLoading = true
                        errorMessage = null
                        coroutineScope.launch {
                            loadAccountData(accountService, apiKeyData!!) { account, balanceList, total, error ->
                                accountInfo = account
                                balances = balanceList
                                totalBalanceUSD = total
                                errorMessage = error
                                isLoading = false

                                // ÌÉ≠Î≥Ñ ÏûêÏÇ∞ Ïû¨Î∂ÑÎ•ò
                                classifyBalancesByTab(balanceList) { spot, earn, futures, spotTotal, earnTotal, futuresTotal ->
                                    spotBalances = spot
                                    earnBalances = earn
                                    futuresBalances = futures
                                    spotTotalUSD = spotTotal
                                    earnTotalUSD = earnTotal
                                    futuresTotalUSD = futuresTotal
                                }
                            }
                        }
                    }
                },
                onSettingsClick = onShowSecuritySettings
            )

            Spacer(modifier = Modifier.height(16.dp))

            // Ïª®ÌÖêÏ∏† ÏòÅÏó≠
            when {
                !hasApiKeys -> {
                    NoApiKeyContentSection(onShowSecuritySettings = onShowSecuritySettings)
                }
                isLoading -> {
                    LoadingContentSection()
                }
                errorMessage != null -> {
                    ErrorContentSection(
                        errorMessage = errorMessage!!,
                        onRetryClick = {
                            if (apiKeyData != null) {
                                isLoading = true
                                errorMessage = null
                                coroutineScope.launch {
                                    loadAccountData(accountService, apiKeyData!!) { account, balanceList, total, error ->
                                        accountInfo = account
                                        balances = balanceList
                                        totalBalanceUSD = total
                                        errorMessage = error
                                        isLoading = false

                                        classifyBalancesByTab(balanceList) { spot, earn, futures, spotTotal, earnTotal, futuresTotal ->
                                            spotBalances = spot
                                            earnBalances = earn
                                            futuresBalances = futures
                                            spotTotalUSD = spotTotal
                                            earnTotalUSD = earnTotal
                                            futuresTotalUSD = futuresTotal
                                        }
                                    }
                                }
                            }
                        }
                    )
                }
                accountInfo != null -> {
                    EnhancedAccountContentSection(
                        accountInfo = accountInfo!!,
                        spotBalances = spotBalances,
                        earnBalances = earnBalances,
                        futuresBalances = futuresBalances,
                        spotTotalUSD = spotTotalUSD,
                        earnTotalUSD = earnTotalUSD,
                        futuresTotalUSD = futuresTotalUSD,
                        isTestnet = isTestnet
                    )
                }
                else -> {
                    EmptyContentSection()
                }
            }
        }
    }
}

@Composable
private fun AccountBalanceHeader(
    hasApiKeys: Boolean,
    isTestnet: Boolean,
    totalBalanceUSD: Double,
    onRefreshClick: () -> Unit,
    onSettingsClick: () -> Unit
) {
    val formatter = DecimalFormat("$#,##0.00")

    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Column {
            Text(
                "Í≥ÑÏ¢å Ï°∞Ìöå",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = Color(0xFF1976D2)
            )
            if (hasApiKeys) {
                Text(
                    if (isTestnet) "üß™ ÌÖåÏä§Ìä∏ÎÑ∑ Î™®Îìú" else "üî¥ Î©îÏù∏ÎÑ∑ Î™®Îìú",
                    fontSize = 12.sp,
                    color = if (isTestnet) Color(0xFFFF9800) else Color(0xFFF44336)
                )
            }
        }

        Row(
            verticalAlignment = Alignment.CenterVertically
        ) {
            if (hasApiKeys && totalBalanceUSD > 0) {
                Column(
                    horizontalAlignment = Alignment.End
                ) {
                    Text(
                        "Ï†ÑÏ≤¥ ÏûêÏÇ∞",
                        fontSize = 10.sp,
                        color = Color.Gray
                    )
                    Text(
                        formatter.format(totalBalanceUSD),
                        fontSize = 14.sp,
                        fontWeight = FontWeight.Bold,
                        color = Color(0xFF1976D2)
                    )
                }
                Spacer(modifier = Modifier.width(8.dp))
            }

            // ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº
            if (hasApiKeys) {
                IconButton(onClick = onRefreshClick) {
                    Icon(
                        Icons.Default.Refresh,
                        contentDescription = "ÏÉàÎ°úÍ≥†Ïπ®",
                        tint = Color(0xFF2196F3)
                    )
                }
            }

            // ÏÑ§Ï†ï Î≤ÑÌäº
            IconButton(onClick = onSettingsClick) {
                Icon(
                    Icons.Default.Settings,
                    contentDescription = "ÏÑ§Ï†ï",
                    tint = Color(0xFF2196F3)
                )
            }
        }
    }
}

@Composable
private fun EnhancedAccountContentSection(
    accountInfo: AccountInfo,
    spotBalances: List<BalanceInfo>,
    earnBalances: List<BalanceInfo>,
    futuresBalances: List<BalanceInfo>,
    spotTotalUSD: Double,
    earnTotalUSD: Double,
    futuresTotalUSD: Double,
    isTestnet: Boolean
) {
    var selectedTab by remember { mutableIntStateOf(0) }

    Column {
        // ÍπîÎÅîÌïú ÌÉ≠ Î©îÎâ¥ (Ï†úÎ™©Îßå)
        Card(
            modifier = Modifier.fillMaxWidth(),
            colors = CardDefaults.cardColors(
                containerColor = Color.White
            )
        ) {
            TabRow(
                selectedTabIndex = selectedTab,
                modifier = Modifier.fillMaxWidth(),
                containerColor = Color.White,
                contentColor = Color(0xFF1976D2)
            ) {
                val tabTitles = listOf("Spot", "Earn", "Futures")

                tabTitles.forEachIndexed { index, title ->
                    Tab(
                        text = {
                            Text(
                                title,
                                fontWeight = if (selectedTab == index) FontWeight.Bold else FontWeight.Normal,
                                fontSize = 16.sp
                            )
                        },
                        selected = selectedTab == index,
                        onClick = { selectedTab = index },
                        selectedContentColor = Color(0xFF1976D2),
                        unselectedContentColor = Color.Gray
                    )
                }
            }
        }

        Spacer(modifier = Modifier.height(12.dp))

        // ÌÉ≠Î≥Ñ Ïª®ÌÖêÏ∏†
        when (selectedTab) {
            0 -> EnhancedSpotBalanceContent(spotBalances, spotTotalUSD)
            1 -> EnhancedEarnBalanceContent(earnBalances, earnTotalUSD)
            2 -> EnhancedFuturesBalanceContent(futuresBalances, futuresTotalUSD)
        }
    }
}

@Composable
private fun EnhancedBalanceListCard(
    title: String,
    balances: List<BalanceInfo>,
    totalUSD: Double,
    cardColor: Color = Color.White,
    titleColor: Color = Color(0xFF1976D2)
) {
    val formatter = DecimalFormat("$#,##0.00")

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = cardColor
        )
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            // Ìó§Îçî (Ï†úÎ™© + Ï¥ù Í∏àÏï°)
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    "$title (${balances.size}Í∞ú)",
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    color = titleColor
                )

                if (totalUSD > 0) {
                    Card(
                        colors = CardDefaults.cardColors(
                            containerColor = Color(0xFFE8F5E8)
                        )
                    ) {
                        Text(
                            "Ï¥ù ${formatter.format(totalUSD)}",
                            fontSize = 14.sp,
                            fontWeight = FontWeight.Bold,
                            color = Color(0xFF2E7D32),
                            modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp)
                        )
                    }
                }
            }

            if (balances.isNotEmpty()) {
                Spacer(modifier = Modifier.height(12.dp))

                LazyColumn(
                    modifier = Modifier.heightIn(max = 300.dp),
                    verticalArrangement = Arrangement.spacedBy(4.dp)
                ) {
                    items(balances) { balance ->
                        EnhancedBalanceRowComponent(balance)
                    }
                }
            }
        }
    }
}

@Composable
private fun EnhancedSpotBalanceContent(balances: List<BalanceInfo>, totalUSD: Double) {
    if (balances.isNotEmpty()) {
        EnhancedBalanceListCard(
            title = "Spot ÏûêÏÇ∞",
            balances = balances,
            totalUSD = totalUSD,
            cardColor = Color(0xFFF3E5F5),
            titleColor = Color(0xFF7B1FA2)
        )
    } else {
        EmptyBalanceCard("Spot ÏûêÏÇ∞Ïù¥ ÏóÜÏäµÎãàÎã§", "üí∞")
    }
}

@Composable
private fun EnhancedEarnBalanceContent(balances: List<BalanceInfo>, totalUSD: Double) {
    if (balances.isNotEmpty()) {
        EnhancedBalanceListCard(
            title = "Earn ÏûêÏÇ∞",
            balances = balances,
            totalUSD = totalUSD,
            cardColor = Color(0xFFE8F5E8),
            titleColor = Color(0xFF2E7D32)
        )
    } else {
        EmptyBalanceCard("Earn ÏûêÏÇ∞Ïù¥ ÏóÜÏäµÎãàÎã§", "üå±")
    }
}

@Composable
private fun EnhancedFuturesBalanceContent(balances: List<BalanceInfo>, totalUSD: Double) {
    if (balances.isNotEmpty()) {
        EnhancedBalanceListCard(
            title = "Futures ÏûêÏÇ∞",
            balances = balances,
            totalUSD = totalUSD,
            cardColor = Color(0xFFFFEBEE),
            titleColor = Color(0xFFC62828)
        )
    } else {
        EmptyBalanceCard("Futures ÏûêÏÇ∞Ïù¥ ÏóÜÏäµÎãàÎã§", "üìà")
    }
}

@Composable
private fun EmptyBalanceCard(message: String, emoji: String = "üíº") {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = Color(0xFFFFF3E0)
        )
    ) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .padding(32.dp),
            contentAlignment = Alignment.Center
        ) {
            Column(
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text(
                    emoji,
                    fontSize = 32.sp
                )
                Spacer(modifier = Modifier.height(8.dp))
                Text(
                    message,
                    fontSize = 16.sp,
                    color = Color(0xFFE65100)
                )
            }
        }
    }
}

@Composable
private fun EnhancedBalanceRowComponent(balance: BalanceInfo) {
    val formatter = DecimalFormat("#,##0.########")
    val totalAmount = BalanceUtils.getTotalBalance(balance)
    val lockedAmount = balance.locked.toDoubleOrNull() ?: 0.0
    val freeAmount = balance.free.toDoubleOrNull() ?: 0.0

    // Í∞ÄÏÉÅÏùò USD Í∞ÄÍ≤© (Ïã§Ï†úÎ°úÎäî APIÏóêÏÑú Í∞ÄÏ†∏ÏôÄÏïº Ìï®)
    val usdValue = calculateUSDValue(balance.asset, totalAmount)

    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = Color(0xFFF8F9FA)
        ),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(12.dp),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            // ÏΩîÏù∏ Ï†ïÎ≥¥
            Column(
                modifier = Modifier.weight(2f)
            ) {
                Text(
                    balance.asset,
                    fontSize = 16.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color(0xFF1976D2)
                )
                if (usdValue > 0) {
                    Text(
                        "$${String.format("%.2f", usdValue)}",
                        fontSize = 10.sp,
                        color = Color(0xFF4CAF50)
                    )
                }
            }

            // ÏûîÍ≥† Ï†ïÎ≥¥
            Column(
                horizontalAlignment = Alignment.End,
                modifier = Modifier.weight(3f)
            ) {
                // Ï¥ù ÏûîÍ≥†
                Text(
                    formatter.format(totalAmount),
                    fontSize = 14.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color(0xFF2E7D32)
                )

                // ÏûêÏú† ÏûêÏÇ∞
                if (freeAmount > 0) {
                    Text(
                        "ÏûêÏú†: ${formatter.format(freeAmount)}",
                        fontSize = 10.sp,
                        color = Color(0xFF388E3C)
                    )
                }

                // Ïû†Í∏¥ ÏûêÏÇ∞
                if (lockedAmount > 0) {
                    Text(
                        "Ïû†ÍπÄ: ${formatter.format(lockedAmount)}",
                        fontSize = 10.sp,
                        color = Color(0xFFFF9800)
                    )
                }
            }
        }
    }
}

// Í∏∞Ï°¥ Ïª¥Ìè¨ÎÑåÌä∏Îì§ (Î≥ÄÍ≤Ω ÏóÜÏùå)
@Composable
private fun NoApiKeyContentSection(onShowSecuritySettings: () -> Unit) {
    Column(
        modifier = Modifier.fillMaxWidth(),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Spacer(modifier = Modifier.height(60.dp))

        Card(
            colors = CardDefaults.cardColors(
                containerColor = Color(0xFFFFF3E0)
            ),
            modifier = Modifier.fillMaxWidth(0.9f)
        ) {
            Column(
                modifier = Modifier.padding(32.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Icon(
                    Icons.Default.Key,
                    contentDescription = null,
                    modifier = Modifier.size(64.dp),
                    tint = Color(0xFFFF9800)
                )
                Spacer(modifier = Modifier.height(20.dp))
                Text(
                    "API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§",
                    fontSize = 20.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color(0xFFE65100),
                    textAlign = TextAlign.Center
                )
                Spacer(modifier = Modifier.height(12.dp))
                Text(
                    "Ïã§Ï†ú Í≥ÑÏ¢å Ï†ïÎ≥¥Î•º Ï°∞ÌöåÌïòÎ†§Î©¥\nÎ∞îÏù¥ÎÇ∏Ïä§ API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî",
                    fontSize = 15.sp,
                    color = Color(0xFFBF360C),
                    textAlign = TextAlign.Center,
                    lineHeight = 22.sp
                )
                Spacer(modifier = Modifier.height(24.dp))
                Button(
                    onClick = onShowSecuritySettings,
                    colors = ButtonDefaults.buttonColors(
                        containerColor = Color(0xFFFF9800),
                        contentColor = Color.White
                    ),
                    modifier = Modifier.fillMaxWidth(0.8f)
                ) {
                    Icon(Icons.Default.Security, contentDescription = null)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        "API ÌÇ§ ÏÑ§Ï†ï",
                        fontSize = 14.sp,
                        fontWeight = FontWeight.Bold
                    )
                }
            }
        }
    }
}

@Composable
private fun LoadingContentSection() {
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(300.dp),
        contentAlignment = Alignment.Center
    ) {
        Column(
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            CircularProgressIndicator(
                color = Color(0xFF2196F3)
            )
            Spacer(modifier = Modifier.height(16.dp))
            Text(
                "Í≥ÑÏ¢å Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...",
                fontSize = 16.sp,
                color = Color.Gray
            )
        }
    }
}

@Composable
private fun ErrorContentSection(
    errorMessage: String,
    onRetryClick: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = Color(0xFFFFEBEE)
        )
    ) {
        Column(
            modifier = Modifier.padding(16.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Icon(
                Icons.Default.Error,
                contentDescription = null,
                tint = Color(0xFFF44336),
                modifier = Modifier.size(48.dp)
            )
            Spacer(modifier = Modifier.height(16.dp))
            Text(
                "Í≥ÑÏ¢å Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®",
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold,
                color = Color(0xFFC62828)
            )
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                errorMessage,
                fontSize = 14.sp,
                color = Color(0xFFD32F2F),
                textAlign = TextAlign.Center
            )
            Spacer(modifier = Modifier.height(16.dp))
            Button(
                onClick = onRetryClick,
                colors = ButtonDefaults.buttonColors(
                    containerColor = Color(0xFFF44336)
                )
            ) {
                Icon(Icons.Default.Refresh, contentDescription = null)
                Spacer(modifier = Modifier.width(8.dp))
                Text("Îã§Ïãú ÏãúÎèÑ")
            }
        }
    }
}

@Composable
private fun EmptyContentSection() {
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(200.dp),
        contentAlignment = Alignment.Center
    ) {
        Text(
            "Í≥ÑÏ¢å Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§",
            fontSize = 16.sp,
            color = Color.Gray
        )
    }
}

// Îç∞Ïù¥ÌÑ∞ ÌÅ¥ÎûòÏä§ (ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú Ï†úÍ±∞)

// Ìó¨Ìçº Ìï®ÏàòÎì§
private fun classifyBalancesByTab(
    balances: List<BalanceInfo>,
    callback: (List<BalanceInfo>, List<BalanceInfo>, List<BalanceInfo>, Double, Double, Double) -> Unit
) {
    val nonZeroBalances = BalanceUtils.getNonZeroBalances(balances)

    // Spot ÏûêÏÇ∞ (ÏùºÎ∞ò Í±∞Îûò ÏûêÏÇ∞)
    val spotAssets = listOf("BTC", "ETH", "BNB", "ADA", "DOT", "LINK", "LTC", "XRP", "DOGE")
    val spotBalances = nonZeroBalances.filter { it.asset in spotAssets }

    // Earn ÏûêÏÇ∞ (Ïä§ÌÖåÏù¥ÌÇπ Í∞ÄÎä•Ìïú ÏûêÏÇ∞)
    val earnAssets = listOf("BNB", "USDT", "BUSD", "ETH", "ADA", "DOT")
    val earnBalances = nonZeroBalances.filter {
        it.asset in earnAssets && BalanceUtils.getTotalBalance(it) >= 10.0 // ÏµúÏÜå Í∏àÏï° Ï°∞Í±¥
    }

    // Futures ÏûêÏÇ∞ (ÏÑ†Î¨º Í±∞ÎûòÏö© ÎßàÏßÑ)
    val futuresAssets = listOf("USDT", "BUSD", "USDC")
    val futuresBalances = nonZeroBalances.filter { it.asset in futuresAssets }

    // Í∞Å ÌÉ≠Î≥Ñ USD Ï¥ùÏï° Í≥ÑÏÇ∞
    val spotTotalUSD = calculateTotalUSDForBalances(spotBalances)
    val earnTotalUSD = calculateTotalUSDForBalances(earnBalances)
    val futuresTotalUSD = calculateTotalUSDForBalances(futuresBalances)

    callback(spotBalances, earnBalances, futuresBalances, spotTotalUSD, earnTotalUSD, futuresTotalUSD)
}

private fun calculateTotalUSDForBalances(balances: List<BalanceInfo>): Double {
    return balances.sumOf { balance ->
        val totalAmount = BalanceUtils.getTotalBalance(balance)
        calculateUSDValue(balance.asset, totalAmount)
    }
}

private fun calculateUSDValue(asset: String, amount: Double): Double {
    // Ïã§Ï†úÎ°úÎäî Î∞îÏù¥ÎÇ∏Ïä§ APIÏóêÏÑú ÌòÑÏû¨ Í∞ÄÍ≤©ÏùÑ Í∞ÄÏ†∏ÏôÄÏïº ÌïòÏßÄÎßå,
    // Ïó¨Í∏∞ÏÑúÎäî Í∞ÄÏÉÅÏùò Í∞ÄÍ≤©ÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§
    val prices = mapOf(
        "USDT" to 1.0,
        "BUSD" to 1.0,
        "USDC" to 1.0,
        "BTC" to 42000.0,
        "ETH" to 2500.0,
        "BNB" to 300.0,
        "ADA" to 0.5,
        "DOT" to 7.0,
        "LINK" to 15.0,
        "LTC" to 70.0,
        "XRP" to 0.6,
        "DOGE" to 0.08
    )

    return (prices[asset] ?: 0.0) * amount
}

// Í≥ÑÏ¢å Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò (Í∏∞Ï°¥Í≥º ÎèôÏùº)
private suspend fun loadAccountData(
    accountService: AccountService,
    apiKeyData: ApiKeyData,
    callback: (AccountInfo?, List<BalanceInfo>, Double, String?) -> Unit
) {
    try {
        val accountResponse = accountService.getAccountInfo(apiKeyData)

        if (accountResponse.success && accountResponse.data != null) {
            val accountInfo = accountResponse.data
            val nonZeroBalances = BalanceUtils.getNonZeroBalances(accountInfo.balances)
            val totalUSD = calculateTotalUSDForBalances(nonZeroBalances)

            callback(accountInfo, nonZeroBalances, totalUSD, null)
        } else {
            callback(null, emptyList(), 0.0, accountResponse.message)
        }
    } catch (e: Exception) {
        callback(null, emptyList(), 0.0, "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: ${e.message}")
    }
}